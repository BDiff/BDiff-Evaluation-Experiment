'''
Copyright (c) [2025] [Song Wansheng, Lu YAO]
BDiff is licensed under Mulan PubL v2.
You can use this software according to the terms and conditions of the Mulan PubL v2.
You may obtain a copy of Mulan PubL v2 at:
         http://openworks.mulanos.cn/#/licenses/MulanPubL-v2
THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND,
EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT,
MERCHANTABILITY OR FIT FOR A PARTICULAR PURPOSE.
See the Mulan PubL v2 for more details.
'''

# encoding:utf-8

import os
from typing import List, Dict
from bs4 import BeautifulSoup
from BDiff import BDiff


def save_file(filename: str, content: str) -> None:
    """
    Save content to a file in the 'html' output directory (creates directory if missing).

    Creates the 'html' directory if it doesn't exist, then writes/overwrites the given content
    to the specified file path within this directory. Prints status messages for file creation/overwriting.

    Args:
        filename: Name of the file to save (e.g., "diff_result.html")
        content: String content to write to the file (typically HTML markup)

    Returns:
        None
    """
    output_path = 'html'

    if not os.path.exists(output_path):
        os.makedirs(output_path)

    filepath = os.path.join(output_path, filename)

    if not os.path.exists(filepath):
        print(f'Create file {filename}')
    else:
        print(f'Overwrite {filename}')

    with open(filepath, 'w', encoding='utf-8') as file:
        file.write(content)
        pass


def get_html_content(
        src: str,
        dest: str,
        edit_script: List[Dict]
) -> str:
    """
    Generate HTML content for visualizing file diffs by injecting data into a template 'index.html'.

    Reads a base HTML template ('index.html'), injects a script tag containing source/destination file
    content, filenames, and semantic edit scripts, then returns the prettified HTML markup.

    Args:
        src: Path/name of the source file (for display in the HTML)
        dest: Path/name of the destination file (for display in the HTML)
        edit_script: List of bdiff edit scripts generated by the BDiff function

    Returns:
        str: Prettified HTML content with injected diff data (ready to save/serve)
    """
    with open(src, 'r', encoding='utf-8') as infile:
        src_lines_list = infile.readlines()
    with open(dest, 'r', encoding='utf-8') as outfile:
        dest_lines_list = outfile.readlines()
    with open('index.html', 'r', encoding='utf-8') as f:
        soup = BeautifulSoup(f.read(), 'html.parser')

        script = soup.new_tag('script')
        script.string = f"content1={repr("\n".join(src_lines_list))};filename1={repr(src)};content2={repr("\n".join(dest_lines_list))};filename2={repr(dest)};diffJson={edit_script};"

        soup.body.append(script)

    return soup.prettify()


def run(src: str, dest: str, output_name: str = '') -> None:
    """
    End-to-end workflow: read source/destination files, generate diff scripts, create HTML, and save output.

    Reads the content of the input files, uses BDiff to generate semantic edit scripts, injects the data
    into an HTML template via get_html_content, and saves the result to the 'html' directory. Uses a default
    output filename if not provided.

    Args:
        src: Path to the source file (original file for diff comparison)
        dest: Path to the destination file (modified file for diff comparison)
        output_name: Optional name for the output HTML file (default: "{src_basename}--{dest_basename}.html")

    Returns:
        None
    """
    if not output_name:
        output_name = f'{os.path.splitext(os.path.basename(src))[0]}--{os.path.splitext(os.path.basename(dest))[0]}.html'

    src_infile = open(src, 'r', encoding='utf-8')
    dest_infile = open(dest, 'r', encoding='utf-8')
    src_lines_list = src_infile.read().splitlines()
    dest_lines_list = dest_infile.read().splitlines()
    src_infile.close()
    dest_infile.close()
    edit_script = BDiff(src, dest, src_lines_list, dest_lines_list)
    html_content = get_html_content(src, dest, edit_script)
    save_file(output_name, html_content)


if __name__ == "__main__":
    # Example: Run diff between "src_file.py" and "dest_file.py", save to "export_path.html"
    # Note: "export_path" here is the OUTPUT HTML filename (not a directory)
    run('src_file.py', 'dest_file.py', 'export_path')



